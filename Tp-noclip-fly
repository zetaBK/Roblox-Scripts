local RS = game:GetService("RunService")
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local lp = Players.LocalPlayer

local enabledTP, enabledNoclip, enabledFly = false, false, false
local connTP, connNoclip, connFly

local flySpeed = 50
local flyBodyGyro = nil
local flyBodyVelocity = nil

local targetName = nil
local target = nil

-- Update target player by name
local function updateTarget()
    if targetName then
        target = Players:FindFirstChild(targetName)
    else
        target = nil
    end
end

-- Update target every second
spawn(function()
    while true do
        updateTarget()
        wait(1)
    end
end)

-- Teleport toggle (stick instantly 2 studs in front)
local function toggleTP(state)
    enabledTP = state
    if connTP then connTP:Disconnect() connTP = nil end
    local char = lp.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end
    if not enabledTP then return end

    connTP = RS.RenderStepped:Connect(function()
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = target.Character.HumanoidRootPart
            local offset = targetHRP.CFrame.LookVector * 2 + Vector3.new(0, 2, 0)
            hrp.CFrame = CFrame.new(targetHRP.Position + offset, targetHRP.Position)
            hrp.AssemblyLinearVelocity = Vector3.new()
            hrp.AssemblyAngularVelocity = Vector3.new()
            hum.PlatformStand = false
        end
    end)
end

-- Noclip toggle
local function toggleNoclip(state)
    enabledNoclip = state
    if connNoclip then connNoclip:Disconnect() connNoclip = nil end
    local char = lp.Character
    if not char then return end
    if not enabledNoclip then
        for _, v in pairs(char:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = true
            end
        end
        return
    end

    connNoclip = RS.Stepped:Connect(function()
        for _, v in pairs(char:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end)
end

-- Fly controls (only modifies speed, no extra velocity or gyro)
local function startFly()
    local char = lp.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    -- Just set Humanoid WalkSpeed to flySpeed for flying speed control
    hum.WalkSpeed = flySpeed

    -- No extra BodyVelocity or BodyGyro to keep movement natural
end

local function stopFly()
    local char = lp.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    -- Reset WalkSpeed to default (16)
    hum.WalkSpeed = 16
end

local function toggleFly(state)
    enabledFly = state
    if enabledFly then
        startFly()
    else
        stopFly()
    end
end

local function preventRagdoll()
    local char = lp.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    hum.PlatformStand = false

    hum.StateChanged:Connect(function(oldState, newState)
        if newState == Enum.HumanoidStateType.Physics or newState == Enum.HumanoidStateType.FallingDown then
            hum:ChangeState(Enum.HumanoidStateType.GettingUp)
        end
    end)
end

lp.CharacterAdded:Connect(function(char)
    char:WaitForChild("HumanoidRootPart", 10)
    char:WaitForChild("Humanoid", 10)
    preventRagdoll()
    if enabledTP then toggleTP(true) end
    if enabledNoclip then toggleNoclip(true) end
    if enabledFly then toggleFly(true) end
end)

preventRagdoll()

-- GUI Setup
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 350, 0, 350)
frame.Position = UDim2.new(0.5, -175, 0.1, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "Zeta's Panel"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 26
title.Parent = frame

-- Minimize button
local btnMinimize = Instance.new("TextButton")
btnMinimize.Size = UDim2.new(0, 40, 0, 40)
btnMinimize.Position = UDim2.new(1, -45, 0, 0)
btnMinimize.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
btnMinimize.TextColor3 = Color3.fromRGB(255, 255, 255)
btnMinimize.Font = Enum.Font.SourceSansBold
btnMinimize.TextSize = 24
btnMinimize.Text = "—"
btnMinimize.Parent = frame

local minimized = false

local function setContentVisibility(visible)
    for _, child in pairs(frame:GetChildren()) do
        if child ~= title and child ~= btnMinimize then
            child.Visible = visible
        end
    end
end

btnMinimize.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        setContentVisibility(false)
        frame.Size = UDim2.new(0, 350, 0, 45)
        btnMinimize.Text = "+"
    else
        setContentVisibility(true)
        frame.Size = UDim2.new(0, 350, 0, 350)
        btnMinimize.Text = "—"
    end
end)

local dragging = false
local dragStart = nil
local startPos = nil

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end
end)

local function createToggleButton(text, position, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 160, 0, 35)
    btn.Position = position
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 20
    btn.Text = text
    btn.Parent = frame
    btn.AutoButtonColor = true

    btn.MouseButton1Click:Connect(function()
        callback(btn)
    end)

    return btn
end

local function createLabel(text, position)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 30)
    label.Position = position
    label.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 20
    label.Text = text
    label.Parent = frame
    return label
end

local function createDropdown(position, width, height)
    local dropdownFrame = Instance.new("TextButton")
    dropdownFrame.Size = UDim2.new(0, width, 0, height)
    dropdownFrame.Position = position
    dropdownFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    dropdownFrame.BorderSizePixel = 0
    dropdownFrame.Text = ""
    dropdownFrame.Parent = frame

    local selectedText = Instance.new("TextLabel")
    selectedText.Size = UDim2.new(1, -30, 1, 0)
    selectedText.Position = UDim2.new(0, 5, 0, 0)
    selectedText.BackgroundTransparency = 1
    selectedText.TextColor3 = Color3.fromRGB(255, 255, 255)
    selectedText.Font = Enum.Font.SourceSans
    selectedText.TextSize = 18
    selectedText.TextXAlignment = Enum.TextXAlignment.Left
    selectedText.Text = "Select Player"
    selectedText.Parent = dropdownFrame

    local arrow = Instance.new("TextLabel")
    arrow.Size = UDim2.new(0, 20, 1, 0)
    arrow.Position = UDim2.new(1, -25, 0, 0)
    arrow.BackgroundTransparency = 1
    arrow.TextColor3 = Color3.fromRGB(255, 255, 255)
    arrow.Font = Enum.Font.SourceSansBold
    arrow.TextSize = 20
    arrow.Text = "▼"
    arrow.Parent = dropdownFrame

    local listFrame = Instance.new("ScrollingFrame")
    listFrame.Size = UDim2.new(1, 0, 0, 150)
    listFrame.Position = UDim2.new(0, 0, 1, 2)
    listFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    listFrame.BorderSizePixel = 0
    listFrame.Visible = false
    listFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    listFrame.ScrollBarThickness = 6
    listFrame.ZIndex = 10
    listFrame.ClipsDescendants = false
    listFrame.Parent = dropdownFrame

    local uiListLayout = Instance.new("UIListLayout")
    uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    uiListLayout.Parent = listFrame

    local function updatePlayers()
        for _, child in pairs(listFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= lp then
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1, -10, 0, 30)
                btn.Position = UDim2.new(0, 5, 0, 0)
                btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                btn.TextColor3 = Color3.fromRGB(255, 255, 255)
                btn.Font = Enum.Font.SourceSans
                btn.TextSize = 18
                btn.Text = player.Name
                btn.Parent = listFrame

                btn.MouseButton1Click:Connect(function()
                    selectedText.Text = player.Name
                    targetName = player.Name
                    updateTarget()
                    listFrame.Visible = false
                end)
            end
        end
        wait() -- Yield so UIListLayout updates
        listFrame.CanvasSize = UDim2.new(0, 0, 0, uiListLayout.AbsoluteContentSize.Y)
    end

    updatePlayers()

    spawn(function()
        while true do
            updatePlayers()
            wait(1)
        end
    end)

    dropdownFrame.MouseButton1Click:Connect(function()
        listFrame.Visible = not listFrame.Visible
    end)

    return dropdownFrame, selectedText, listFrame
end

local function createSlider(position, width, min, max, default, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(0, width, 0, 50)
    sliderFrame.Position = position
    sliderFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    sliderFrame.BorderSizePixel = 0
    sliderFrame.Parent = frame
    sliderFrame.ZIndex = 10

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Font = Enum.Font.SourceSans
    label.TextSize = 18
    label.Text = "Fly Speed: " .. tostring(default)
    label.Parent = sliderFrame

    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1, -20, 0, 15)
    bar.Position = UDim2.new(0, 10, 0, 30)
    bar.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    bar.Parent = sliderFrame

    local fill = Instance.new("Frame")
    fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
    fill.Parent = bar

    local dragging = false

    bar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
        end
    end)

    bar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    bar.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local relativeX = math.clamp(input.Position.X - bar.AbsolutePosition.X, 0, bar.AbsoluteSize.X)
            local value = min + (relativeX / bar.AbsoluteSize.X) * (max - min)
            fill.Size = UDim2.new((value - min) / (max - min), 0, 1, 0)
            label.Text = "Fly Speed: " .. string.format("%.1f", value)
            callback(value)
        end
    end)

    return sliderFrame
end

-- Create sections and UI elements positioning
local yPos = 50
local sectionSpacing = 10

-- Teleport Section
createLabel("Teleport", UDim2.new(0, 0, 0, yPos))
yPos = yPos + 30 + sectionSpacing

local dropdown, selectedText, listFrame = createDropdown(UDim2.new(0, 10, 0, yPos), 330, 35)
yPos = yPos + 35 + sectionSpacing

local btnTP = createToggleButton("Teleport: OFF", UDim2.new(0, 10, 0, yPos), function(btn)
    toggleTP(not enabledTP)
    btn.Text = "Teleport: " .. (enabledTP and "ON" or "OFF")
end)
yPos = yPos + 35 + sectionSpacing

-- Noclip Section
createLabel("Noclip", UDim2.new(0, 0, 0, yPos))
yPos = yPos + 30 + sectionSpacing

local btnNoclip = createToggleButton("Noclip: OFF", UDim2.new(0, 10, 0, yPos), function(btn)
    toggleNoclip(not enabledNoclip)
    btn.Text = "Noclip: " .. (enabledNoclip and "ON" or "OFF")
end)
yPos = yPos + 35 + sectionSpacing

-- Fly Section
createLabel("Fly", UDim2.new(0, 0, 0, yPos))
yPos = yPos + 30 + sectionSpacing

local btnFly = createToggleButton("Fly: OFF", UDim2.new(0, 10, 0, yPos), function(btn)
    toggleFly(not enabledFly)
    btn.Text = "Fly: " .. (enabledFly and "ON" or "OFF")
end)
yPos = yPos + 35 + sectionSpacing

local sliderFlySpeed = createSlider(UDim2.new(0, 10, 0, yPos), 330, 10, 200, flySpeed, function(value)
    flySpeed = value
    if enabledFly then
        local char = lp.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                hum.WalkSpeed = flySpeed
            end
        end
    end
end)
